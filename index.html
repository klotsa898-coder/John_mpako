<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beekeeping Pro - 7 Day History</title>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #ffffff; --accent: #1a73e8; --border: #333; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        
        /* Banner Î™ÏƒÏ„Î¿ÏÎ¹ÎºÎ¿Ï 7 Î—Î¼ÎµÏÏÎ½ */
        .history-container { display: flex; overflow-x: auto; gap: 8px; margin-bottom: 15px; padding-bottom: 5px; }
        .history-day { background: var(--card); min-width: 80px; padding: 10px; border-radius: 12px; border: 1px solid var(--border); text-align: center; flex: 1; }
        .hist-date { font-size: 0.6em; color: #888; text-transform: uppercase; }
        .hist-val { font-size: 0.9em; font-weight: bold; margin-top: 4px; }

        .last-update { font-size: 0.75em; color: #ffca28; text-align: center; margin-bottom: 10px; background: #252525; padding: 8px; border-radius: 10px; border: 1px solid #444; }
        
        .toolbar { background: var(--card); padding: 10px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        .grid-container { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media(min-width: 600px) { .grid-container { grid-template-columns: 1fr 1fr; } }
        
        .card { background: var(--card); border-radius: 15px; padding: 15px; border-top: 5px solid var(--accent); }
        .header-flex { display: flex; justify-content: space-between; align-items: center; }
        h3 { margin: 0; font-size: 0.85em; color: #888; text-transform: uppercase; }
        .value-display { font-size: 2.2em; font-weight: bold; margin: 5px 0; display: flex; align-items: baseline; }
        .stats-row { display: flex; gap: 10px; font-size: 0.75em; color: #777; margin-bottom: 10px; border-top: 1px solid #2a2a2a; padding-top: 5px; }
        .chart-box { width: 100%; height: 140px; }
        select { background: #333; color: white; border: none; padding: 8px; border-radius: 8px; font-size: 11px; }
    </style>
</head>
<body>

    <div style="font-size: 0.7em; color: #888; margin-bottom: 5px; text-align: center;">Î™Î£Î¤ÎŸÎ¡Î™ÎšÎŸ 7 Î—ÎœÎ•Î¡Î©Î (21:00 - 21:00)</div>
    <div class="history-container" id="historyLog">
        </div>

    <div class="last-update" id="mainUpdate">ğŸ•’ Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</div>

    <div class="toolbar">
        <span style="font-size: 0.75em; color: #888;">Î•ÏÏÎ¿Ï‚ Î“ÏÎ±Ï†Î·Î¼Î¬Ï„Ï‰Î½:</span>
        <select id="resultsRange" onchange="loadData()">
            <option value="10">10 Î¼ÎµÏ„Ï.</option>
            <option value="20" selected>20 Î¼ÎµÏ„Ï.</option>
            <option value="50">50 Î¼ÎµÏ„Ï.</option>
        </select>
    </div>

    <div id="dashboard" class="grid-container"></div>

    <script>
        const channelID = '1946870'; 
        const readAPIKey = 'VTEARWKSJCFE3DNE';

        const fieldConfig = {
            'field1': { label: 'Î’Î¬ÏÎ¿Ï‚', unit: 'gr', icon: 'âš–ï¸', color: '#ff5252', decimals: 0 },
            'field2': { label: 'Î¥Î³ÏÎ±ÏƒÎ¯Î±', unit: '%', icon: 'ğŸ’§', color: '#448aff', decimals: 1 },
            'field3': { label: 'Î˜ÎµÏÎ¼Î¿ÎºÏÎ±ÏƒÎ¯Î±', unit: 'Â°C', icon: 'ğŸŒ¡ï¸', color: '#4caf50', decimals: 1 },
            'field4': { label: 'ÎœÏ€Î±Ï„Î±ÏÎ¯Î±', unit: 'V', icon: 'ğŸ”‹', color: '#ffc107', decimals: 2 },
            'field5': { label: 'Î”Î¹Î±Ï†Î¿ÏÎ¬ (Î ÏÎ¿Î·Î³.)', unit: 'gr', icon: 'ğŸ“‰', color: '#ff4081', decimals: 0 }
        };

        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(() => { loadData(); loadHistory(); });

        async function loadHistory() {
            try {
                // Î–Î·Ï„Î¬Î¼Îµ Î±ÏÎºÎµÏ„Î¬ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± 8 Î·Î¼Î­ÏÎµÏ‚ Ï€Î¯ÏƒÏ‰ (Î³Î¹Î± Î½Î± Î­Ï‡Î¿Ï…Î¼Îµ 7 Î´Î¹Î±Ï†Î¿ÏÎ­Ï‚)
                const res = await fetch(`https://api.thingspeak.com/channels/${channelID}/fields/1.json?api_key=${readAPIKey}&results=800`);
                const data = await res.json();
                const feeds = data.feeds;
                const historyLog = document.getElementById('historyLog');
                historyLog.innerHTML = '';

                const getWeightAt21 = (targetDate) => {
                    const target = new Date(targetDate);
                    target.setHours(21, 0, 0);
                    const closest = feeds.reduce((prev, curr) => 
                        Math.abs(new Date(curr.created_at) - target) < Math.abs(new Date(prev.created_at) - target) ? curr : prev
                    );
                    return parseFloat(closest.field1);
                };

                // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î³Î¹Î± Ï„Î¹Ï‚ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯ÎµÏ‚ 7 Î·Î¼Î­ÏÎµÏ‚
                for (let i = 0; i < 7; i++) {
                    const day0 = new Date(); day0.setDate(day0.getDate() - i);
                    const day1 = new Date(); day1.setDate(day1.getDate() - (i + 1));

                    const w0 = getWeightAt21(day0);
                    const w1 = getWeightAt21(day1);
                    const diff = ((w0 - w1) / 1000).toFixed(2);
                    const color = diff >= 0 ? '#4caf50' : '#ff5252';
                    const dateStr = day0.toLocaleDateString('el-GR', { weekday: 'short', day: 'numeric' });

                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'history-day';
                    dayDiv.innerHTML = `
                        <div class="hist-date">${dateStr}</div>
                        <div class="hist-val" style="color:${color}">${diff > 0 ? '+' : ''}${diff}k</div>
                    `;
                    historyLog.appendChild(dayDiv);
                }
            } catch(e) { console.error("History Error:", e); }
        }

        function loadData() {
            const num = document.getElementById('resultsRange').value;
            fetch(`https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${readAPIKey}&results=${num}`)
            .then(res => res.json()).then(data => {
                if(!data.feeds.length) return;
                const lastFeed = data.feeds[data.feeds.length - 1];
                const lastDate = new Date(lastFeed.created_at);
                document.getElementById('mainUpdate').innerText = `ğŸ•’ Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± Î¼Î­Ï„ÏÎ·ÏƒÎ·: ${lastDate.toLocaleDateString('el-GR')} | ${lastDate.toLocaleTimeString('el-GR', {hour:'2-digit', minute:'2-digit'})}`;

                const dashboard = document.getElementById('dashboard');
                dashboard.innerHTML = '';
                
                Object.keys(fieldConfig).forEach(key => {
                    const conf = fieldConfig[key];
                    const feedsArr = data.feeds.map(f => parseFloat(f[key])).filter(v => !isNaN(v));
                    const lastVal = feedsArr[feedsArr.length - 1];
                    const maxVal = Math.max(...feedsArr);
                    const minVal = Math.min(...feedsArr);

                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="header-flex"><h3>${conf.label}</h3><span>${conf.icon}</span></div>
                        <div class="value-display" style="color:${conf.color}">
                            ${lastVal.toFixed(conf.decimals)}<span style="font-size:0.4em; color:#666; margin-left:5px;">${conf.unit}</span>
                        </div>
                        <div class="stats-row">
                            <span>MIN: ${minVal.toFixed(conf.decimals)}</span>
                            <span>MAX: ${maxVal.toFixed(conf.decimals)}</span>
                        </div>
                        <div id="chart_${key}" class="chart-box"></div>
                    `;
                    dashboard.appendChild(card);
                    drawChart(data.feeds, key, conf.label, conf.color);
                });
            });
        }

        function drawChart(feeds, key, label, color) {
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Time');
            dataTable.addColumn('number', label);
            feeds.forEach(f => {
                let v = parseFloat(f[key]);
                if (!isNaN(v)) dataTable.addRow([new Date(f.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), v]);
            });
            new google.visualization.LineChart(document.getElementById('chart_'+key)).draw(dataTable, {
                backgroundColor: 'transparent', curveType: 'function', legend: 'none',
                hAxis: { textPosition: 'none' }, vAxis: { gridlines: {color:'#2a2a2a'}, textStyle: {color:'#555'} },
                colors: [color], chartArea: {width:'90%', height:'80%'}
            });
        }

        setInterval(() => { loadData(); loadHistory(); }, 60000);
    </script>
</body>
</html>
